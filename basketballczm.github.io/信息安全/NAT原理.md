## NAT network address transfor

## 基本概念  
PreRouting DNAT  在中间代理处路由前更改来自主机B的数据包的目的地址和端口  更改的是目的地址 (外网到内网)  
PostRouting SNAT 在中间代理处路由后更改数据包的源IP地址和端口(端口可能不是8123，可能是另外一个端口)  更改的是源地址(内网到外网)

外部主机B： 192.168.116.1    
代理(防火墙)： 192.168.116.141:8123    
内网主机A: 192.168.116.164:80

原来的数据包                     |  iptables   |      更改后的数据包| 备注|
------------                    |-------------|-------------------|----|
源IP:192.168.116.1 目的地址和端口:192.168.116.141:8123| sudo iptables -t nat -A PREROUTING -p tcp --dport:8123 -j DNAT -to 192.168.116.164:80   | 源IP：192.168.116.1 目的ip和端口：192.168.116.164:80| 路由前更改来自主机B的数据包的目的IP地址和端口，改为192.168.116.164:80
源IP：192.168.116.1 目的ip和端口：192.168.116.164:80| sudo iptables -t nat -A POSTROUTING -p tcp -s 192.168.116.1 -j SNAT -to 192.168.116.141 | 源IP：192.168.116.141:(某一端口)目的ip和端口:192.168.116.164:80 | 路由后更改数据包的源IP地址 改为：192.168.116.141
源IP和端口：192.168.116.164:80 目的IP：192.168.116.141 | sudo iptables -t nat -A PREROUTING -p tcp -s 192.168.116.164 -sport：80 -j DNAT -to 192.168.116.1 | 源IP和端口：192.168.116.164:80 目的IP：192.168.116.1  | 路由前更改来自主机A的数据包的目的IP地址，改为192.168.116.1 |
源IP和端口：192.168.116.164:80 目的IP：192.168.116.1 | sudo iptables -t nat -A POSTROUTING -p tcp -s 192.168.116.164 -sport:80 -j SNAT -to 192.168.116.141:8123 | 源IP和端口：192.168.116.141:8123 目的IP：192.168.116.1 | 路由后更改数据包的源IP地址和端口改为：192.168.116.141:8123


![图片](<images/1.png>)

## 注意事项 
1. NAT只需要转换源IP地址或者目的IP地址(相当于防火墙) 正向代理
2. 代理既需要转换源IP也需要转换目的IP(转换需要多一次) 反向代理
3. 对于上面的四条规则，因为NAT比较智能，只需要加前面两条规则即可，数据也能返回给外部主机。

关主机的所有流量 
sudo iptables -F -t nat
sudo iptables -p INPUT DROP

sudo iptables -p INPUT ACCEPT

telnet 目的端口是23
sudo iptables -A INPUT -p tcp --dport:23 -j ACCEPT

ftp 服务的控制端口是21，数据传输端口是20
sudo iptables -A INPUT -p tcp -m state --sport 