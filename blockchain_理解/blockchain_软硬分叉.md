## blockchain 基础知识

### 硬分叉

对比特币协议增加了一些新的特性和功能，没有升级这些协议的节点认为新的特性和功能是不合法的。但是新节点认可新旧协议挖出来的块，旧节点只认可旧协议挖出来的块。

比特币的区块容量有1M变为4M就是一个典型的例子。

但是硬分叉会导致新链和旧链的交易会相互被广播，可以采用chainID来解决。

50%以上的算力可以导致永久的硬分叉。

![在这里插入图片描述](https://img-blog.csdnimg.cn/20190711194637516.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1NIVTE1MTIxODU2,size_16,color_FFFFFF,t_70)

### 软分叉

新协议为某些字段增加新含义，或者增加新功能。也就是对比特币协议添加一些限制，使得原来某些合法的交易或者区块，在限制后的新区块变得不合法，形成软分叉。新节点不认可旧区块，只认可新区块。旧节点认可新区块和旧区块。

假设协议更新将区块的限制大小变小，从1M变为0.5M。假设大多数算力都是新节点，即已经更新了协议，此时旧节点认为新节点挖出的块是合法的。但是新节点认为旧节点挖出的块不是合法的。所以在这种情况下，会持续出现软分叉，只要旧节点不更新协议，挖出的区块就一直无法上链，相比硬分叉，软分叉即是非永久存在的分叉，只会临时存在一段时间。

![在这里插入图片描述](https://img-blog.csdnimg.cn/20190711222126348.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1NIVTE1MTIxODU2,size_16,color_FFFFFF,t_70)

实际软分叉的情况

1. 当前协议中为限制的一些域被赋予新的规则，一个例子就是铸币交易的CoinBase域，没人规定也没人检查。
2. P2SH形式的交易脚本是比特币系统中后面通过软分叉加入的。

P2SH即在支付时输出不是收款人公钥的哈希，而是一个赎回脚本（Redeem Script）的哈希。

在赎回（把这些BTC花出去）时分为两阶段，第一阶段验证输入脚本中给出的赎回脚本，和前面交易的输出脚本中的赎回脚本的哈希对得上，第二阶段执行赎回脚本，验证输入脚本中给出的签名是合法的。

对于旧节点而言，并不知道赎回脚本的这些特性，旧节点只会做第一阶段的验证，即验证赎回脚本是不是正确的（和哈希对得上）。只有新节点才会把两阶段的验证都做完。

所以旧节点验证通过的交易，可能是第二阶段验证无法通过的P2SH形式的交易，在新节点上无法验证通过。而新节点验证通过的交易，旧节点也都验证通过。

### 总结protocol fork

#### 软分叉的特点

只要系统中半数以上（算力）的节点更新了软件，就不会出现永久性的分叉。这类分叉为软分叉。

#### 硬分叉的特点

必须系统中所有（算力）的节点都更新了软件，才不会出现永久性的分叉。


## 参考文档

* [硬分叉和软分叉](https://blog.csdn.net/SHU15121856/article/details/95494629)